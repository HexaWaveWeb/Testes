<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
        #loginForm, #registerForm {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 40px auto;
        }
        input[type="email"], input[type="password"], input[type="text"], button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #1877f2;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #166fe5;
        }
        #chatList {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .chat-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .chat-item:hover {
            background-color: #f5f5f5;
        }
        #chatWindow {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        #chatMessages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 20px;
            max-width: 70%;
        }
        .message.sent {
            background-color: #dcf8c6;
            align-self: flex-end;
        }
        .message.received {
            background-color: #f1f0f0;
            align-self: flex-start;
        }
        #messageForm {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }
        #messageInput {
            flex-grow: 1;
            margin-right: 10px;
        }
        #logoutButton {
            position: absolute;
            top: 20px;
            right: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginForm">
            <h2>Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Senha" required>
            <button id="loginButton">Entrar</button>
            <p>Não tem uma conta? <a href="#" id="showRegister">Registre-se</a></p>
        </div>

        <div id="registerForm" class="hidden">
            <h2>Registro</h2>
            <input type="email" id="registerEmail" placeholder="Email" required>
            <input type="password" id="registerPassword" placeholder="Senha" required>
            <input type="text" id="registerName" placeholder="Nome" required>
            <button id="registerButton">Registrar</button>
            <p>Já tem uma conta? <a href="#" id="showLogin">Faça login</a></p>
        </div>

        <div id="chatApp" class="hidden">
            <button id="logoutButton">Sair</button>
            <h2>Chats</h2>
            <div id="chatList"></div>
            <h3>Novo Chat</h3>
            <input type="text" id="newChatUser" placeholder="Email do usuário">
            <input type="text" id="newChatTitle" placeholder="Título do chat">
            <button id="createChatButton">Criar Chat</button>
            <div id="chatWindow" class="hidden">
                <div id="chatMessages"></div>
                <form id="messageForm">
                    <input type="text" id="messageInput" placeholder="Digite sua mensagem...">
                    <button type="submit">Enviar</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar os módulos do Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        import { getDatabase, ref, set, push, onValue, get } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js';

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCF50W92_ZmSLGcDLlOr8r7QtF__JchP50",
            authDomain: "webuserdata.firebaseapp.com",
            databaseURL: "https://webuserdata-default-rtdb.firebaseio.com",
            projectId: "webuserdata",
            storageBucket: "webuserdata.appspot.com",
            messagingSenderId: "996591404387",
            appId: "1:996591404387:web:0d2f5d16b9494de4997f56",
            measurementId: "G-VTDKLXL5TS"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // Elementos do DOM
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const chatApp = document.getElementById('chatApp');
        const chatList = document.getElementById('chatList');
        const chatWindow = document.getElementById('chatWindow');
        const chatMessages = document.getElementById('chatMessages');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const logoutButton = document.getElementById('logoutButton');
        const createChatButton = document.getElementById('createChatButton');
        const newChatUser = document.getElementById('newChatUser');
        const newChatTitle = document.getElementById('newChatTitle');

        let currentUser = null;
        let currentChat = null;

        // Função para mostrar/esconder elementos
        function showElement(element, show = true) {
            element.classList.toggle('hidden', !show);
        }

        // Autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showElement(loginForm, false);
                showElement(registerForm, false);
                showElement(chatApp, true);
                loadChats();
            } else {
                currentUser = null;
                showElement(loginForm, true);
                showElement(registerForm, false);
                showElement(chatApp, false);
            }
        });

        // Login
        document.getElementById('loginButton').addEventListener('click', () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => alert('Erro no login: ' + error.message));
        });

        // Registro
        document.getElementById('registerButton').addEventListener('click', () => {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const name = document.getElementById('registerName').value;
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    set(ref(db, 'users/' + userCredential.user.uid), {
                        name: name,
                        email: email
                    });
                })
                .catch((error) => alert('Erro no registro: ' + error.message));
        });

        // Logout
        logoutButton.addEventListener('click', () => {
            signOut(auth).catch((error) => alert('Erro no logout: ' + error.message));
        });

        // Alternar entre login e registro
        document.getElementById('showRegister').addEventListener('click', () => {
            showElement(loginForm, false);
            showElement(registerForm, true);
        });

        document.getElementById('showLogin').addEventListener('click', () => {
            showElement(loginForm, true);
            showElement(registerForm, false);
        });

        // Carregar chats
        function loadChats() {
            const chatsRef = ref(db, 'chats');
            onValue(chatsRef, (snapshot) => {
                chatList.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const chatData = childSnapshot.val();
                    if (chatData.participants.includes(currentUser.uid)) {
                        const chatElement = document.createElement('div');
                        chatElement.className = 'chat-item';
                        chatElement.textContent = chatData.title;
                        chatElement.addEventListener('click', () => openChat(childSnapshot.key, chatData.title));
                        chatList.appendChild(chatElement);
                    }
                });
            });
        }

        // Abrir chat
        function openChat(chatId, chatTitle) {
            currentChat = chatId;
            showElement(chatWindow, true);
            document.querySelector('#chatWindow h2').textContent = chatTitle;
            loadMessages(chatId);
        }

        // Carregar mensagens
        function loadMessages(chatId) {
            const messagesRef = ref(db, `messages/${chatId}`);
            onValue(messagesRef, (snapshot) => {
                chatMessages.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const messageData = childSnapshot.val();
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${messageData.sender === currentUser.uid ? 'sent' : 'received'}`;
                    messageElement.textContent = messageData.text;
                    chatMessages.appendChild(messageElement);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        // Enviar mensagem
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const messageText = messageInput.value.trim();
            if (messageText && currentChat) {
                const newMessageRef = push(ref(db, `messages/${currentChat}`));
                set(newMessageRef, {
                    sender: currentUser.uid,
                    text: messageText,
                    timestamp: Date.now()
                });
                messageInput.value = '';
            }
        });

        // Criar novo chat
        createChatButton.addEventListener('click', () => {
            const userEmail = newChatUser.value.trim();
            const chatTitle = newChatTitle.value.trim();
            if (userEmail && chatTitle) {
                get(ref(db, 'users')).then((snapshot) => {
                    let targetUser = null;
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        if (userData.email === userEmail) {
                            targetUser = childSnapshot.key;
                        }
                    });
                    if (targetUser) {
                        const newChatRef = push(ref(db, 'chats'));
                        set(newChatRef, {
                            title: chatTitle,
                            participants: [currentUser.uid, targetUser]
                        }).then(() => {
                            newChatUser.value = '';
                            newChatTitle.value = '';
                            alert('Chat criado com sucesso!');
                        }).catch((error) => alert('Erro ao criar chat: ' + error.message));
                    } else {
                        alert('Usuário não encontrado.');
                    }
                });
            } else {
                alert('Por favor, preencha todos os campos.');
            }
        });
    </script>
</body>
</html>
